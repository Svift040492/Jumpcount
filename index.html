<!doctype html>
<html lang="ru">
<meta charset="utf-8" />
<title>Счётчик прыжков (упрощённый)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body { font-family: sans-serif; padding: 20px; }
#count { font-size: 48px; font-weight: bold; margin-top: 10px; }
button { padding: 10px 16px; margin-right: 8px; }
</style>
<h1>Счётчик прыжков (упрощённый)</h1>
<button id="start">Старт</button>
<button id="stop" disabled>Стоп</button>
<div id="status">Статус: Ожидание</div>
<div id="count">0</div>

<script>
(() => {
  let jumpCount = 0;
  let listening = false;
  let lastJumpTime = 0;
  const JUMP_THRESHOLD = 12.0;  // Порог взлёта
  const COOLDOWN = 400;         // мс задержка после прыжка

  // Фильтрация гравитации (low-pass filter)
  let gravity = { x:0, y:0, z:0 };
  const alpha = 0.8;

  const countEl = document.getElementById("count");
  const statusEl = document.getElementById("status");

  function setStatus(text) {
    statusEl.textContent = "Статус: " + text;
  }

  function processAccel(ax, ay, az) {
    // Фильтрация гравитации
    gravity.x = alpha * gravity.x + (1 - alpha) * ax;
    gravity.y = alpha * gravity.y + (1 - alpha) * ay;
    gravity.z = alpha * gravity.z + (1 - alpha) * az;

    const linx = ax - gravity.x;
    const liny = ay - gravity.y;
    const linz = az - gravity.z;

    const magnitude = Math.sqrt(linx*linx + liny*liny + linz*linz);

    const now = Date.now();

    if (magnitude > JUMP_THRESHOLD && (now - lastJumpTime) > COOLDOWN) {
      jumpCount++;
      countEl.textContent = jumpCount;
      lastJumpTime = now;
      setStatus("Прыжок засчитан!");
    }
  }

  function startSensors() {
    if (typeof DeviceMotionEvent !== "undefined" &&
        typeof DeviceMotionEvent.requestPermission === "function") {
      DeviceMotionEvent.requestPermission().then(response => {
        if (response === "granted") {
          window.addEventListener("devicemotion", motionHandler);
          listening = true;
          setStatus("Датчики включены");
        } else {
          setStatus("Доступ к датчикам отклонён");
        }
      });
    } else {
      window.addEventListener("devicemotion", motionHandler);
      listening = true;
      setStatus("Датчики включены");
    }
  }

  function motionHandler(e) {
    let ax = e.accelerationIncludingGravity.x;
    let ay = e.accelerationIncludingGravity.y;
    let az = e.accelerationIncludingGravity.z;
    processAccel(ax, ay, az);
  }

  function stopSensors() {
    window.removeEventListener("devicemotion", motionHandler);
    listening = false;
    setStatus("Остановлено");
  }

  document.getElementById("start").addEventListener("click", () => {
    if (!listening) {
      jumpCount = 0;
      countEl.textContent = jumpCount;
      startSensors();
    }
  });

  document.getElementById("stop").addEventListener("click", () => {
    if (listening) {
      stopSensors();
    }
  });
})();
</script>
